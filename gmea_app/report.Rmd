---
title: "LAM - Infinium Enrichment Analysis Tool Report"
output:
  html_document:
    smart: false
theme: cosmo
params:
  res: NA
  minsetsize: NA
  prioritisation: NA
---

## Background

LAM is short for limma-average-mitch and is a tool for gene set enrichment analysis of
Infinium array data.
As the name suggests, the process begins with a limma table of differential methylation
of probes.
Each gene could have one or hundreds of probes, so to aggregate them, LAM finds the
average value for each gene.
These values can then undergo enrichment analysis with other general purpose tools.
In this case we are using [mitch](https://doi.org/10.1186/s12864-020-06856-9), 
because it is accurate and has nice visualisation features.

Mitch uses a rank-ANOVA approach which was described previously by [Cox and Mann 2012](https://doi.org/10.1186/1471-2105-13-S16-S12).

This software was developed by Mark Ziemann, report issues at the [GitHub repository](https://github.com/markziemann/gmea_app).

Some information about the parameters used:

```{r, start, echo=FALSE}
res <- params$res
minsetsize <- params$minsetsize
prioritisation <- params$prioritisation

message(paste("Minimum gene set size:",minsetsize))

message(paste("Prioritisation:",prioritisation))

```

Minimum set size is the detection threshold for gene sets.
Sets with fewer than this number of genes are discarded.

Prioritisation can be effect size or significance.
Effect size is normally preferred because we are normally interested in pathways
with large fold changes.
Significance can be used if the number of significant pathways found is small.

## Input profiles

Here is the first few lines of the input profile.

```{r,checklibraries,echo=FALSE}

suppressPackageStartupMessages({
    library("echarts4r")
    library("dplyr")
    library("tibble")
    library("gtools")
    library("gplots")
    library("beeswarm")
    library("reshape2")
    library("ggplot2")
    library("GGally")
    library("pkgload")
    library("kableExtra")
})

```


```{r,peek,echo=FALSE}

# capture the dimensionality of the data                                               
d=ncol(res$input_profile)

# if working with >5 dimensions, then substitute the dimension (colnames) names with a number
if ( d>5 ) {
    mydims<-data.frame(seq_len(d))
    mydims$colnames<-attributes(res)$profile_dimensions
    colnames(mydims)<-c("dimension","contrast_name")
    print(kbl( mydims, caption = "Profile dimensions" ) %>%
    kable_styling("hover", full_width = FALSE))
    colnames(res$input_profile)<- paste("d",seq_len(d),sep="")
    colnames(res$ranked_profile)<- paste("d",seq_len(d),sep="")
    ss<-res$ranked_profile
}

head(res$input_profile) %>%
  kbl(caption="The profiling data being passed to mitch") %>%
  kable_styling("hover", full_width = FALSE)

```

Here are some metrics about the input data profile:

```{r, metrics, echo=FALSE}

formatted<-t(as.data.frame(res$analysis_metrics[ c(1,2,3,4,5 ) ]))

colnames(formatted)="Profile metrics"

formatted %>%
  kbl(caption="Profiling data metrics") %>%
  kable_styling("hover", full_width = FALSE)

```

Here is a plot of the input profiles. Note the dynamic ranges.

```{r, scatterplot, echo=FALSE,fig.height = 6, fig.width = 6.5, message=FALSE, warning=FALSE}

par(mfrow=c(2,1))
hist(res$input_profile[,1],breaks=50,main="Distribution of DE scores",xlab=paste("DE score for ",colnames(res$input_profile)))
plot(res$input_profile,xlab=paste("DE score for ",colnames(res$input_profile)),
pch="|",frame.plot=FALSE)
UPS=length(which(res$input_profile>0))
DNS=length(which(res$input_profile<0))
TOTAL=nrow(res$input_profile)
mtext(paste(TOTAL,"genes in total,",UPS,"trending up-regulated,",DNS,"trending down-regulated"))

```

## Input genesets

Here are some metrics about the gene sets used:

```{r,input_geneset_metrics1,results="asis",echo=FALSE}

ORIGINFILE=attributes(res$input_genesets)$originfile
cat(paste("GMT file of genesets:",ORIGINFILE,"<br>"))
unformatted<-t(as.data.frame(res$analysis_metrics[c(1,6,7)]))
formatted<-as.data.frame(as.character( unformatted[1:3]) )
rownames(formatted)=rownames(unformatted)
colnames(formatted)="Gene sets metrics"

formatted %>%
  kbl(caption="Gene set metrics") %>%
  kable_styling("hover", full_width = F)

```

```{r,input_geneset_metrics2,results="asis",echo=FALSE ,fig.height = 7, fig.width = 7 ,fig.show="all"}

par(mfrow=c(3,1))
geneset_counts<-res$analysis_metrics$geneset_counts
boxplot(geneset_counts$count,horizontal=TRUE,frame=FALSE,main="Gene set size",xlab="number of member genes included in profile")
hist(geneset_counts$count,100,xlab="geneset size",main="Histogram of geneset size")
hist(geneset_counts$count,100,xlim=c(0,500),xlab="geneset size",main="Trimmed histogram of geneset size")

if ( d==2 ) {
    uu=length(which(res$input_profile[,1]>0 & res$input_profile[,2]>0))
    ud=length(which(res$input_profile[,1]>0 & res$input_profile[,2]<0))
    dd=length(which(res$input_profile[,1]<0 & res$input_profile[,2]<0))
    du=length(which(res$input_profile[,1]<0 & res$input_profile[,2]>0))
    a<-as.data.frame(c(uu,ud,dd,du))
    rownames(a)=c("top-right","bottom-right","bottom-left","top-left")
    colnames(a)="a"
    par(mfrow=c(1,1))
    xx<-barplot(a$a,names.arg=rownames(a),main="number of genes in each quadrant")
    text(x = xx, y = a$a, label = a$a , pos = 1, cex = 1)
} else if (d>2) {
    if (d<6) {
        sig<-sign(ss)
        sector_count<-aggregate(seq_len(nrow(sig)) ~ ., sig, FUN = length)
        colnames(sector_count)[ncol(sector_count)]<-"Count"

         sector_count %>%
         kbl(caption="Genes by sector") %>%
         kable_styling("hover", full_width = FALSE)
    }

}

```

```{r,input_geneset_metrics3,results="asis",echo=FALSE,message=FALSE,fig.height = 7, fig.width = 7}

cat("<h2>Differential pathway expression</h2><br>")
par(mfrow=c(1,1))
sig<-subset(res$enrichment_result,p.adjustANOVA<=0.05)

plot(res$enrichment_result$s.dist,-log10(res$enrichment_result$pANOVA),
  xlab="s score",ylab="-log10(p-value)",
  main="volcano plot of gene set enrichments",pch=19,cex=0.8)

points(sig$s.dist,-log10(sig$pANOVA),pch=19,cex=0.85,col="red")
TOTAL=nrow(res$enrichment_result)
SIG=nrow(sig)
UP=length(which(sig$s.dist>0))
DN=length(which(sig$s.dist<0))
SUBHEADER=paste(TOTAL,"gene sets in total,",UP,"upregulated and ",DN,"downregulated (FDR<=0.05)")
mtext(SUBHEADER)

```

## Interactive enrichment scatterplot

```{r,echart1d,results="asis",echo=FALSE, fig.height = 7, fig.width = 7 ,fig.show="all", message=FALSE}

numsets=nrow(subset(res$enrichment_result,p.adjustANOVA<0.05))

resrows=length(res$detailed_sets)
if (resrows>1) {
    myres2<-head(res$enrichment_result,resrows)
    myres2$significance<--log10(myres2$pANOVA)
    myres2$set<-sub(",","",myres2$set)
    XCOL=colnames(myres2)[4]
    YCOL=colnames(myres2)[6]
    colnames(myres2)[4]<-"xx"
    colnames(myres2)[6]<-"yy"
    
    p2<-myres2 %>%
      tibble::rownames_to_column("model") %>%
      mutate(set = paste(set, setSize, p.adjustANOVA , sep = ",")) %>%
      e_charts(x = xx) %>%
      e_legend(show = FALSE) %>%
      e_x_axis(name = XCOL) %>%  # add x axis name
      e_y_axis(name = YCOL) %>%  # add y axis name
      e_scatter( serie = yy , bind = set , symbolSize = 10  ) %>%
      e_tooltip(formatter = htmlwidgets::JS("
                function(params){
                var vals = params.name.split(',')
                return('<strong>' + vals[0] +
                '</strong><br />s.x-axis: ' + parseFloat(params.value[0]).toFixed(2) +
                '<br />s.y-axis: ' +  parseFloat(params.value[1]).toFixed(2)) +
                '<br />setSize: ' + vals[1] +
                '<br />p-adjust ANOVA: ' + Number(vals[2]).toPrecision(2)
            }"))
    
    cat("Significance is calculated by -log10(p-value). Top N sets shown irrespective of FDR.<br>")
    p2
}

```

## Results table

```{r,results_table,results="asis",echo=FALSE}

resrows=length(res$detailed_sets)
myres<-head(res$enrichment_result,resrows)
myres[,c(3:ncol(myres))]<-signif(myres[,c(3:ncol(myres))],3)

formatted<-myres
formatted[,1]<-gsub("_"," ",myres[,1])

kbl( formatted , format="markdown", row.names=FALSE, caption = cat(paste("Top N=",resrows,"gene sets")) ,digits=100) %>%
kable_styling("hover", full_width = FALSE)

cat("<hr><br>")

```

## Results (complete table)

```{r,results_table_complete,results="asis",echo=FALSE}

myres<-res$enrichment_result

myres[,c(3:ncol(myres))]<-signif(myres[,c(3:ncol(myres))],3)
formatted<-myres
formatted[,1]<-gsub("_"," ",myres[,1])

HEADER=paste("<br><details><summary><b>","Click HERE to show results for all gene sets","</b></summary><br><p>",sep=" " )

cat(HEADER)

kbl(formatted, format="html", row.names=FALSE, caption = "Complete results",digits=100) %>%
kable_styling("hover", full_width = FALSE)

cat("<br></p></details>")
cat("<hr><br>")

```

```{r,detailed_geneset_reports1d,results="asis",echo=FALSE,fig.height=6, fig.width=6 ,out.width = '80%',comment=NA, message=FALSE}

if (d==1) {
    cat("<h2>Detailed Gene set reports</h2><br>")
    cat('<br>')
    cat('\n')
    ss<-res$ranked_profile

    for ( i in seq_len(resrows) ) {
        mydat = NULL
        mydat<-t(myres[i,])

        cat(paste("<b>",as.character(myres[i,1]) ,"</b><br>"))

        tbl <- kbl(mydat,col.names = NULL,format='pipe',caption=NULL ) %>%
            kable_styling("hover", full_width = FALSE)

        cat(tbl)
        cat('\n\n<!-- -->\n\n')
        cat("<br>")

        # plots
        sss<-res$detailed_sets[[i]]
        set<-names(res$detailed_sets[i])
        size<-length(sss)
        par(mfrow=c(3,1))

        beeswarm(sss,vertical = FALSE,cex=0.75,xlim=c(min(ss),
        max(ss)),col="darkgray",pch=19,main=set,cex.main=1.5,
        xlab=paste("ranked DE score in:",colnames(ss)))

        mtext("beeswarm plot",cex=0.8)

        hist(sss,xlim=c(min(ss),max(ss)),breaks=15,col="darkgray",main=NULL,
        border="black",xlab=paste("ranked DE score in:",colnames(ss)))

        mtext("histogram",cex=0.8)

        plot(sss,rep(1,length(sss)),type="n",xlim=c(min(ss),max(ss)),
        frame=FALSE,axes=FALSE,ylab="",
        xlab=paste("ranked DE score in:",colnames(ss)))

        rug(sss, ticksize = 0.9)
        axis(1)
        mtext("rugplot",cex=0.8)
        cat("<br>")

        # top gene list
        setSign=sign(res$enrichment_result[i,4])

        if (setSign==-1) {
            tops<-as.data.frame(res$detailed_sets[[i]][order(res$detailed_sets[[i]])])
        } else if (setSign==1) {
            tops<-as.data.frame(res$detailed_sets[[i]][order(-res$detailed_sets[[i]])])
        }

        cat("Top enriched genes\\n")
        tops$GeneID<-rownames(tops)
        tops<-tops[,c(2,1)]
        colnames(tops)=c("GeneID","Gene Rank")
        cat("<br>")

        tbl <- kbl(head(tops,n=20L), format='pipe', row.names=FALSE,caption="Top 20 genes",digits=100) %>%
                kable_styling("hover", full_width = FALSE)

        cat(tbl)
        cat('\n\n<!-- -->\n\n')
        HEADER=paste("<br><details><summary><b>","Click HERE to show all gene set members","</b></summary><br><p>",sep=" " )
        cat(HEADER)

        tbl <- kbl(tops, format='pipe', row.names=FALSE, caption="All member genes",digits=100) %>%
                kable_styling("hover", full_width = FALSE)

        cat(tbl)
        cat('\n\n<!-- -->\n\n')
        cat("<br></p></details>")
        cat("<br><hr>")
    }
}

```

Here is the session info with all the versions of packages used.

```{r session_info, include=TRUE, echo=TRUE, results='markup'}

sessionInfo()

```

END of report